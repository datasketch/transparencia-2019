library(tidyverse)
library(openxlsx)
library(jsonlite)
#casos_tem <- casos_tem %>% select(`id caso` = id_caso, latitud, longitud)
# actores <- fromJSON(actoresUrl)
casos <- read.xlsx("data/original/Base de datos limpia Hechos con actores.xlsx")
casos <- casos[c(-1,-2),]
names(casos) <- trimws(casos[1,])
casos <- casos[-1,]
casos <- casos %>% unite("Delito", `Delito 1`:`Delito 7`, remove = F, sep = ". ")
casos$Delito <- trimws(gsub("NA\\.|NA", "", casos$Delito))
casos$new <- ifelse(casos$`Situación Judicial` == "No Aplica" |
casos$`Situación Judicial` == "Otros" |
casos$`Situación Judicial` == "Absuelto" |
casos$`Situación Judicial` == "Investigado" |
casos$`Situación Judicial` == "No Disponible", NA, casos$Actor)
names(casos) <- gsub("#", "Número de ", names(casos))
names(casos)[names(casos) == "Sector_2"] <- "Sector Afectado"
labelCasos <- iconv(tolower(gsub("[[:space:]]", "_",names(casos))), to='ASCII//TRANSLIT')
labelCasos[labelCasos == "dinero_recuperado_y/o_multa_impuesta"] <- "dinero_recuperado"
dic_casos <- data.frame(label = names(casos),
id = labelCasos)
names(casos) <- labelCasos
casos <- Filter(function(z) !all(is.na(z)), casos)
varInf <- data.frame(id  = names(casos))
dic_casos <- varInf %>% left_join(dic_casos)
library(datafringe)
dic_casos$ctype <- getCtypes(casos)
casos <- map_df(casos, trimws)
casos <- casos %>%
map(function(z) {
d <- gsub("No aplica|no aplica", "No Aplica", z)
gsub("No disponible|no disponible", "No Disponible", d)
}) %>% bind_rows()
write_csv(casos, "app/data/clean/casos_all_data.csv", na = "")
write_csv(dic_casos, "app/data/clean/casos_all_dic.csv",  na = "")
func_paste <- function(x) paste(unique(x), collapse = '. ')
casos <- casos %>%
group_by(id_caso) %>%
summarise_each(funs(func_paste))
casos <- casos %>%
map(function(z) {
d <- gsub("\\. NA|NA\\.|. NA|NA\\. |. NA|. NA", "", z)
d <- gsub(" No disponible|no disponible|No disponible|No aplica|\\. no aplica|no aplica|No Disponible|No Aplica|No Aplica\\.|No disponible\\.", "", d)
d <- gsub("\\.\\.|\\. \\.", ".", d)
d <- gsub("^\\.", "", d)
d <- trimws(gsub("NA", "", d))
d
}) %>% bind_rows()
casos$departamento[casos$departamento == 'RIÑO'] <- 'NARIÑO'
casos$departamento[casos$departamento == 'AMAZOS'] <- 'AMAZONAS'
casos$departamento[casos$departamento == 'MAGDALE'] <- 'MAGDALENA'
casos$departamento[casos$departamento == 'NORTE SANTANDER'] <- 'NORTE DE SANTANDER'
casos$departamento[casos$departamento == 'VALLE'] <- 'VALLE DEL CAUCA'
casos$departamento[casos$departamento == 'GUAJIRA'] <- 'LA GUAJIRA'
casos$departamento[casos$departamento == 'CASARE'] <- 'CASANARE'
unique(casos$departamento)
casos$departamento[casos$departamento == 'BOGOTÁ, DISTRITO CAPITAL'] <- 'BOGOTÁ, D. C.'
casos$departamento[casos$departamento == 'CUNDIMARCA'] <- 'CUNDINAMARCA'
write_csv(casos, "app/data/clean/casos_agregadas_data.csv", na = "")
unique(casos$departamento)
