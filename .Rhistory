library(tidyverse)
library(openxlsx)
library(jsonlite)
#casosUrl <- "http://50.31.146.35/~wwwmonit/monitorCorrupcion/admin/api/reporte/vistasApi.php?flag=casos"
# notasUrl <- "http://50.31.146.35/~wwwmonit/monitorCorrupcion/admin/api/reporte/vistasApi.php?flag=notas"
# actoresUrl <- "http://50.31.146.35/~wwwmonit/monitorCorrupcion/admin/api/reporte/vistasApi.php?flag=actores"
# casos <- fromJSON(casosUrl)
# actores <- fromJSON(actoresUrl)
casos <- read.xlsx("data/original/Base de datos limpia Hechos con actores.xlsx")
casos <- casos[c(-1,-2),]
names(casos) <- trimws(casos[1,])
casos <- casos[-1,]
names(casos) <- gsub("#", "NÃºmero de ", names(casos))
names(casos)[names(casos) == "Sector_2"] <- "Sector Afectado"
labelCasos <- iconv(tolower(gsub("[[:space:]]", "_",names(casos))), to='ASCII//TRANSLIT')
labelCasos[labelCasos == "dinero_recuperado_y/o_multa_impuesta"] <- "dinero_recuperado"
dic_casos <- data.frame(label = names(casos),
id = labelCasos)
names(casos) <- labelCasos
casos <- Filter(function(z) !all(is.na(z)), casos)
varInf <- data.frame(id  = names(casos))
dic_casos <- varInf %>% left_join(dic_casos)
library(datafringe)
dic_casos$ctype <- getCtypes(casos)
casos <- map_df(casos, trimws)
casos <- casos %>%
map(function(z) {
d <- gsub("No aplica|no aplica", "No Aplica", z)
gsub("No disponible|no disponible", "No Disponible", d)
}) %>% bind_rows()
func_paste <- function(x) paste(unique(x), collapse = '. ')
casos <- casos %>%
group_by(id_caso) %>%
summarise_each(funs(func_paste))
casos <- casos %>%
map(function(z) {
d <- gsub("\\. NA|NA\\.|. NA|NA\\. |. NA|. NA", "", z)
d <- gsub(" No disponible|no disponible|No disponible|No aplica|\\. no aplica|no aplica|No Disponible|No Aplica|No Aplica\\.|No disponible\\.", "", d)
d <- gsub("\\.\\.|\\. \\.", ".", d)
d <- gsub("^\\.", "", d)
d <- trimws(gsub("NA", "", d))
d
}) %>% bind_rows()
write_csv(casos, "app/data/clean/casos_agregadas_data.csv", na = "")
